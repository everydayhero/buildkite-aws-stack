#!/bin/bash -ie

if [ -z "$PLANFILE" ]; then
  echo "PLANFILE is not set or empty"
  exit 1
fi

echo "~~~ Initialising :terraform:"
terraform init -backend=true -backend-config="bucket=$STATE_BUCKET" -backend-config="key=$STATE_KEY" -input=false -force-copy

echo "+++ Planning :terraform:"
terraform plan -refresh=false -input=false -out "$PLANFILE"

if hash buildkite-agent 2> /dev/null; then
  echo "~~~ Uploading :terraform:"
  buildkite-agent artifact upload "$PLANFILE" "$BUILDKITE_ARTIFACT_UPLOAD_DESTINATION"
fi
