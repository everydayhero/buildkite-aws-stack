---
env:
  BUILDKITE_S3_ACL: private

steps:
  - name: ":terminal: Test"
    command: "bin/run-tests"
    env:
      BUILDKITE_DOCKER_COMPOSE_CONTAINER: app
      BUILDKITE_DOCKER_COMPOSE_FILE: docker-compose.test.yml

  - name: ":terraform: Validate"
    command: ".buildkite/bin/validate"

  - name: ":cop: Users"
    command: ".buildkite/bin/generate-and-upload-authorized-users"

  - name: ":composer: Env"
    command: ".buildkite/bin/generate-and-upload-env"

  - wait

  - name: ":terraform: Plan"
    command: "buildkite-agent artifact download \"*\" . && .buildkite/bin/plan"
    env:
      TF_VAR_authorized_users: authorized-users
      TF_VAR_env_script: env

  - wait

  - name: ":terraform: Apply"
    command: "buildkite-agent artifact download \"*\" . && .buildkite/bin/apply"
    branches: master

  - wait

  - name: ":suspect: Test plain-utils pull"
    command: "plain-utils pull payments-staging"
    branches: master

  - name: ":suspect: Test docker hub pull + push"
    command: "docker pull everydayhero/hello_world:latest && docker push everydayhero/hello_world:latest"
    branches: master
