#!/bin/bash

set -e -o pipefail

source ~/cfn-env

export AWS_REGION
export AWS_DEFAULT_REGION

main() {
  local key="$1"
  local aws_s3_args=("--region=$AWS_DEFAULT_REGION" "--metadata" "BuildNumber=\"${BUILD_NUMBER}\",Commit=\"${COMMIT}\",Branch=\"${BRANCH}\",BuildUrl=\"${BUILD_URL}\"")

  if [ -n "$2" ]; then
    SECRETS_BUCKET="$2"
  fi

  if [[ -n "${BUILDKITE_SECRETS_KEY:-}" ]] ; then
    aws_s3_args+=("--sse-c" "AES256" "--sse-c-key" "${BUILDKITE_SECRETS_KEY}")
  elif [[ "${BUILDKITE_USE_KMS:-true}" =~ ^(true|1)$ ]] ; then
    aws_s3_args+=("--sse" "aws:kms")
  elif [[ -n "${BUILDKITE_S3_ACL:-}" ]] ; then
    aws_s3_args+=("--acl" "${BUILDKITE_S3_ACL}")
  fi

  aws s3 cp "${aws_s3_args[@]}" "$key" "s3://${SECRETS_BUCKET}/${key}"
}

main "$@"
